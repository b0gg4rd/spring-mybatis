<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.coatli.springmybatis.persistence.PersonMapper">

  <resultMap id="readResultMap"
             type="Person">
    <constructor>
      <idArg javaType="string"   column="id"   jdbcType="VARCHAR" />
      <arg   javaType="string"   column="name"        jdbcType="VARCHAR" />
    </constructor>
    <result property="age"       javaType="integer"   column="age"       jdbcType="INTEGER" />
  </resultMap>
  
  <resultMap id="readWithAddressResultMap"
             type="Person"
             extends="readResultMap">
    <constructor>
      <idArg javaType="string"   column="person_id"   jdbcType="VARCHAR" />
      <arg   javaType="string"   column="name"        jdbcType="VARCHAR" />
    </constructor>
    <association property="address"
                 resultMap="net.coatli.springmybatis.persistence.AddressMapper.readResultMap" />
  </resultMap>

  <insert id="create"
          parameterType="Person">
    INSERT INTO
      person
    (
      id,
      name,
      age
      <if test="address != null">
      ,fk_address
      </if>
    )
    VALUES
    (
      #{key,     mode=IN, javaType=String,  jdbcType=VARCHAR},
      #{name,    mode=IN, javaType=String,  jdbcType=VARCHAR},
      #{age,     mode=IN, javaType=Integer, jdbcType=INTEGER}
      <if test="address != null and address.key != null">
      ,#{address.key,   mode=IN, javaType=Integer, jdbcType=INTEGER}
      </if>
    )
  </insert>

  <select id="read"
          parameterType="string"
          resultMap="readResultMap">
    SELECT
      id,
      name,
      age
    FROM
      person
    WHERE
      id = #{key, mode=IN, javaType=String, jdbcType=VARCHAR}
  </select>
  
  <select id="readWithAddress"
          parameterType="string"
          resultMap="readWithAddressResultMap">
    SELECT
      p.id as person_id,
      p.name,
      p.age,
      a.id,
      a.street,
      a.number
    FROM
      person p LEFT JOIN address a ON p.fk_address = a.id
    WHERE
      p.id = #{key, mode=IN, javaType=String, jdbcType=VARCHAR}
  </select>
  
  <update id="update"
          parameterType="Person">
    UPDATE
      person
    SET
      <if test="name != null">
      name = #{name,   mode=IN, javaType=String,  jdbcType=VARCHAR}
      </if>
      <if test="age != null">
      ,age = #{age,   mode=IN, javaType=Integer, jdbcType=INTEGER}
      </if>
      <if test="address != null">
      ,fk_address = #{address.key,   mode=IN, javaType=Integer, jdbcType=INTEGER}
      </if>
    WHERE
      id = #{key, mode=IN, javaType=String, jdbcType=VARCHAR}
  </update>
  
  <delete id="delete"
          parameterType="Person">
    DELETE FROM
      person
    WHERE
      id = #{key, mode=IN, javaType=String, jdbcType=VARCHAR}
  </delete>
  
</mapper>